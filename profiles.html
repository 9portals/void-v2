<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Profiles - VOID</title>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: monospace;
      margin: 0;
    }
    header {
      background-color: #111;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #333;
    }
    .nav a {
      color: white;
      margin: 0 10px;
      text-decoration: none;
      border: 1px solid white;
      padding: 4px 8px;
    }
    .profile-card {
      border: 1px solid white;
      margin: 10px;
      padding: 10px;
    }
    .online { color: lightgreen; }
    .offline { color: red; }
    button {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <header>
    <div><b>VOID</b></div>
    <div class="nav">
      <a href="index.html">Home</a>
      <a href="accounts.html">Profile</a>
      <a href="profiles.html">View Profiles</a>
      <a href="echoes.html">Echoes</a>
      <a href="messages.html">Messages</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>
  </header>

  <main>
    <h2 style="text-align:center;">All Profiles</h2>
    <div id="profilesContainer"></div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      onValue,
      update,
      set,
      push
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD1YgjFsxh-xZfeHlrxt_0igmH6SBIMcuc",
      authDomain: "void-d9ec4.firebaseapp.com",
      databaseURL: "https://void-d9ec4-default-rtdb.firebaseio.com",
      projectId: "void-d9ec4",
      storageBucket: "void-d9ec4.appspot.com",
      messagingSenderId: "267268035851",
      appId: "1:267268035851:web:1e5ab79c51db42160f3e0e",
      measurementId: "G-ZYMQ3Z6LC5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    let currentUser = null;
    let currentUserData = null;

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        loadProfiles();
        onValue(ref(db, `users/${user.uid}`), snap => {
          currentUserData = snap.val();
        });
      } else {
        window.location.href = "index.html";
      }
    });

    function logout() {
      signOut(auth);
    }

    function loadProfiles() {
      onValue(ref(db, 'users'), snapshot => {
        const users = snapshot.val();
        const list = Object.entries(users || {}).filter(([uid]) => uid !== currentUser.uid);
        const sorted = list.sort((a, b) => (b[1].online || 0) - (a[1].online || 0));

        const container = document.getElementById('profilesContainer');
        container.innerHTML = "";

        const seen = new Set();

        for (const [uid, data] of sorted) {
          if (seen.has(uid)) continue;
          seen.add(uid);

          const card = document.createElement('div');
          card.className = 'profile-card';

          const status = data.online && (Date.now() - data.online < 30000) ? 'online' : 'offline';
          const isFollowing = currentUserData?.following?.[uid];

          card.innerHTML = `
            <div><b>${data.username || "Unnamed"}</b> - <span class="${status}">${status}</span></div>
            <div>${data.bio || "No bio"}</div>
            <div>Age: ${data.age || "?"} | Gender: ${data.gender || "?"}</div>
            <img src="${data.profilePic || ''}" style="max-width:100px;max-height:100px;"><br/>
          `;

          const followBtn = document.createElement('button');
          followBtn.textContent = isFollowing ? "Unfollow" : "Follow";
          followBtn.onclick = () => {
            const updates = {};
            updates[`users/${currentUser.uid}/following/${uid}`] = isFollowing ? null : true;
            updates[`users/${uid}/followers/${currentUser.uid}`] = isFollowing ? null : true;
            update(ref(db), updates);
          };

          const dmBtn = document.createElement('button');
          dmBtn.textContent = "Send DM";
          dmBtn.onclick = () => {
            const msg = prompt("Enter your message:");
            if (msg) {
              const dmRef = push(ref(db, 'dms'));
              set(dmRef, {
                from: currentUser.uid,
                to: uid,
                message: msg,
                createdAt: Date.now(),
                displayName: currentUserData?.username || "User"
              }).then(() => {
                alert("DM sent! It will expire in 1 hour.");
              });
            }
          };

          card.appendChild(followBtn);
          card.appendChild(dmBtn);
          container.appendChild(card);
        }
      });
    }
  </script>
</body>
</html>
