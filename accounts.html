<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Accounts - The Void</title>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: sans-serif;
      text-align: center;
    }
    .container {
      max-width: 400px;
      margin: 40px auto;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      background: #111;
      color: white;
      border: 1px solid #444;
    }
    .toggle-link {
      color: #00f;
      cursor: pointer;
      margin-top: 10px;
      display: inline-block;
    }
    .hidden {
      display: none;
    }
    img {
      max-width: 100px;
      max-height: 100px;
      margin-top: 10px;
      border-radius: 50%;
    }
    .logout-btn {
      background: red;
    }
  </style>
</head>
<body>

  <div class="container">
    <h2 id="formTitle">Login</h2>

    <div id="authSection">
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
      <input type="text" id="username" placeholder="Username" class="hidden" />
      <button id="authButton">Login</button>
      <div class="toggle-link" id="toggleForm">Don't have an account? Sign up</div>
    </div>

    <div id="verifyNotice" class="hidden">
      <p>Please verify your email to unlock full access.</p>
      <button onclick="sendVerification()">Resend Verification Email</button>
    </div>

    <div id="profileSection" class="hidden">
      <h3>Edit Profile</h3>
      <input type="text" id="name" placeholder="Name">
      <input type="number" id="age" placeholder="Age">
      <select id="gender">
        <option value="">Select Gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
      </select>
      <textarea id="bio" placeholder="Bio"></textarea>
      <input type="file" id="profilePic" accept="image/*">
      <img id="previewPic" class="hidden" />
      <button onclick="saveProfile()">Save Profile</button>
      <button onclick="logout()" class="logout-btn">Logout</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD1YgjFsxh-xZfeHlrxt_0igmH6SBIMcuc",
      authDomain: "void-d9ec4.firebaseapp.com",
      databaseURL: "https://void-d9ec4-default-rtdb.firebaseio.com",
      projectId: "void-d9ec4",
      storageBucket: "void-d9ec4.appspot.com",
      messagingSenderId: "267268035851",
      appId: "1:267268035851:web:d535fe4175c06f170f3e0e",
      measurementId: "G-78DGNW8HV3"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    let isSignup = false;

    const email = document.getElementById("email");
    const password = document.getElementById("password");
    const username = document.getElementById("username");
    const name = document.getElementById("name");
    const age = document.getElementById("age");
    const gender = document.getElementById("gender");
    const bio = document.getElementById("bio");
    const profilePic = document.getElementById("profilePic");
    const previewPic = document.getElementById("previewPic");

    document.getElementById("toggleForm").addEventListener("click", () => {
      isSignup = !isSignup;
      document.getElementById("formTitle").innerText = isSignup ? "Sign Up" : "Login";
      document.getElementById("authButton").innerText = isSignup ? "Sign Up" : "Login";
      username.classList.toggle("hidden", !isSignup);
      document.getElementById("toggleForm").innerText = isSignup ? "Already have an account? Login" : "Don't have an account? Sign up";
    });

    document.getElementById("authButton").addEventListener("click", () => {
      if (isSignup) {
        auth.createUserWithEmailAndPassword(email.value, password.value)
          .then(cred => {
            const uid = cred.user.uid;
            db.ref("users/" + uid).set({
              username: username.value,
              verified: false
            });
            sendVerification();
          }).catch(err => {
            alert(err.message);
          });
      } else {
        auth.signInWithEmailAndPassword(email.value, password.value)
          .catch(err => {
            alert(err.message);
          });
      }
    });

    function sendVerification() {
      const user = auth.currentUser;
      if (user) {
        user.sendEmailVerification().then(() => {
          alert("Verification email sent.");
        }).catch(err => {
          alert(err.message);
        });
      }
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        if (!user.emailVerified) {
          document.getElementById("authSection").classList.add("hidden");
          document.getElementById("verifyNotice").classList.remove("hidden");
        } else {
          document.getElementById("authSection").classList.add("hidden");
          document.getElementById("verifyNotice").classList.add("hidden");
          document.getElementById("profileSection").classList.remove("hidden");
          loadProfile();
        }
      } else {
        document.getElementById("authSection").classList.remove("hidden");
        document.getElementById("verifyNotice").classList.add("hidden");
        document.getElementById("profileSection").classList.add("hidden");
      }
    });

    function logout() {
      auth.signOut();
    }

    profilePic.addEventListener("change", function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          previewPic.src = e.target.result;
          previewPic.classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      }
    });

    function saveProfile() {
      const user = auth.currentUser;
      if (!user) return;

      const uid = user.uid;
      const file = profilePic.files[0];
      const profileData = {
        name: name.value,
        age: age.value,
        gender: gender.value,
        bio: bio.value
      };

      if (file) {
        const storageRef = storage.ref("profilePics/" + uid);
        const uploadTask = storageRef.put(file);

        uploadTask.then(snapshot => {
          return snapshot.ref.getDownloadURL();
        }).then(url => {
          profileData.profilePic = url;
          return db.ref("users/" + uid).update(profileData);
        }).then(() => {
          alert("Profile saved!");
        }).catch(err => {
          console.error(err);
          alert("Error uploading image.");
        });
      } else {
        db.ref("users/" + uid).update(profileData).then(() => {
          alert("Profile saved!");
        }).catch(err => {
          alert(err.message);
        });
      }
    }

    function loadProfile() {
      const uid = auth.currentUser.uid;
      db.ref("users/" + uid).once("value").then(snapshot => {
        const data = snapshot.val();
        if (data) {
          name.value = data.name || "";
          age.value = data.age || "";
          gender.value = data.gender || "";
          bio.value = data.bio || "";
          if (data.profilePic) {
            previewPic.src = data.profilePic;
            previewPic.classList.remove("hidden");
          }
        }
      }).catch(err => {
        console.error(err);
      });
    }
  </script>
</body>
</html>
