<!DOCTYPE html>
<html>
<head>
  <title>Firebase Upload Test (Improved)</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
</head>
<body style="background:black; color:white; text-align:center; padding:40px;">

  <h2>Upload Profile Picture (Debug Mode)</h2>
  <input type="file" id="fileInput" accept="image/*" />
  <br><br>
  <button id="uploadBtn" disabled>Upload</button>
  <p id="status" style="white-space: pre-line; font-family: monospace;">Status: Loading...</p>
  <img id="preview" src="" style="display:none; max-width:200px; margin-top:20px;" />

  <script>
    const status = document.getElementById('status');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const preview = document.getElementById('preview');

    function updateStatus(msg) {
      console.log(msg);
      status.textContent = "Status: " + msg;
    }

    const firebaseConfig = {
      apiKey: "AIzaSyD1YgjFsxh-xZfeHlrxt_0igmH6SBIMcuc",
      authDomain: "void-d9ec4.firebaseapp.com",
      databaseURL: "https://void-d9ec4-default-rtdb.firebaseio.com",
      projectId: "void-d9ec4",
      storageBucket: "void-d9ec4.appspot.com",
      messagingSenderId: "267268035851",
      appId: "1:267268035851:web:d535fe4175c06f170f3e0e"
    };

    firebase.initializeApp(firebaseConfig);

    let currentUser = null;

    firebase.auth().signInWithEmailAndPassword('florisveen@gmail.com', '42884288')
      .then(userCredential => {
        currentUser = userCredential.user;
        updateStatus("Signed in as: " + currentUser.email);
        uploadBtn.disabled = false;
      })
      .catch(error => {
        updateStatus("Login failed: " + error.message);
      });

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
        updateStatus("Image loaded. Ready to upload.");
      }
    });

    uploadBtn.addEventListener('click', () => {
      const file = fileInput.files[0];
      if (!file) {
        updateStatus("No file selected.");
        return;
      }

      if (!currentUser) {
        updateStatus("User not signed in.");
        return;
      }

      updateStatus("Uploading...");

      const storageRef = firebase.storage().ref('profilePictures/' + currentUser.uid + '.jpg');
      storageRef.put(file)
        .then(snapshot => {
          updateStatus("Upload complete. Getting download URL...");
          return snapshot.ref.getDownloadURL();
        })
        .then(downloadURL => {
          updateStatus("Success!\nURL: " + downloadURL);
          preview.src = downloadURL;

          return firebase.database().ref('users/' + currentUser.uid).update({
            profilePicture: downloadURL
          });
        })
        .catch(error => {
          updateStatus("Upload failed: " + error.message);
        });
    });
  </script>

</body>
</html>
