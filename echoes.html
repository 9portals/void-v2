<!DOCTYPE html>
<html>
<head>
  <title>Echoes - The Void</title>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #111;
      padding: 10px 20px;
      text-align: center;
    }
    nav a {
      color: white;
      margin: 0 10px;
      text-decoration: none;
    }
    #echoContainer {
      padding: 20px;
    }
    .echo {
      border: 1px solid #333;
      margin-bottom: 10px;
      padding: 10px;
      background-color: #111;
      cursor: pointer;
    }
    .echo-content {
      display: none;
      margin-top: 10px;
    }
    .reply {
      margin-left: 20px;
      margin-top: 10px;
      border-top: 1px dashed #555;
      padding-top: 5px;
    }
    .timer {
      font-size: 0.8em;
      color: gray;
      margin-left: 10px;
    }
    .author {
      font-size: 0.9em;
      color: lightgray;
      margin-left: 10px;
    }
    textarea {
      width: 100%;
      height: 180px;
      padding: 12px;
      background: #000;
      color: white;
      border: 1px solid #333;
      margin-top: 10px;
      resize: vertical;
    }
    input {
      width: 100%;
      padding: 10px;
      background: #000;
      color: white;
      border: 1px solid #333;
      margin-top: 10px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translate(-50%, -20%);
      background: #111;
      border: 1px solid #444;
      padding: 20px;
      z-index: 1000;
    }
    .modal.show {
      display: block;
    }
    .btn {
      background: #222;
      border: 1px solid #555;
      padding: 10px 15px;
      color: white;
      cursor: pointer;
      margin-top: 10px;
    }
    .fold-toggle {
      font-size: 0.8em;
      color: #888;
      float: right;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="index.html">Home</a>
      <a href="view-profiles.html">View Profiles</a>
      <a href="global-chat.html">Global Chat</a>
      <a href="echoes.html">Echoes</a>
      <a href="edit-profile.html">Edit Profile</a>
      <a href="login.html">Login</a>
    </nav>
  </header>

  <div id="echoContainer"></div>

  <div class="modal" id="titleModal">
    <h3>Enter Echo Title</h3>
    <input id="echoTitleInput" placeholder="Thread Title">
    <input id="echoAuthorInput" placeholder="Optional Username">
    <button class="btn" onclick="nextEchoStep()">Next</button>
  </div>

  <div class="modal" id="contentModal">
    <h3>Enter Echo Content</h3>
    <textarea id="echoContentInput" placeholder="What's your message?"></textarea>
    <button class="btn" onclick="postEcho()">Post Echo</button>
  </div>

  <div class="modal" id="replyModal">
    <h3>Reply to Echo</h3>
    <input id="replyAuthorInput" placeholder="Optional Username">
    <textarea id="replyContentInput" placeholder="Write your reply..."></textarea>
    <button class="btn" onclick="submitReply()">Post Reply</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      push,
      set,
      update
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCnJW3-f6qM6FYcdSUDAo_NbFpxcWl38Kw",
      authDomain: "void-d9ec4.firebaseapp.com",
      projectId: "void-d9ec4",
      storageBucket: "void-d9ec4.appspot.com",
      messagingSenderId: "267268035851",
      appId: "1:267268035851:web:d535fe4175c06f170f3e0e",
      databaseURL: "https://void-d9ec4-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentEchoKey = null;

    const echoContainer = document.getElementById('echoContainer');
    const titleModal = document.getElementById('titleModal');
    const contentModal = document.getElementById('contentModal');
    const replyModal = document.getElementById('replyModal');

    const echoTitleInput = document.getElementById('echoTitleInput');
    const echoAuthorInput = document.getElementById('echoAuthorInput');
    const echoContentInput = document.getElementById('echoContentInput');
    const replyContentInput = document.getElementById('replyContentInput');
    const replyAuthorInput = document.getElementById('replyAuthorInput');

    function openEchoModal() {
      titleModal.classList.add('show');
    }

    function nextEchoStep() {
      titleModal.classList.remove('show');
      contentModal.classList.add('show');
    }

    function postEcho() {
      const title = echoTitleInput.value;
      const content = echoContentInput.value;
      const author = echoAuthorInput.value.trim() || "Anonymous";
      const now = Date.now();
      const expiration = now + 10 * 60 * 1000;

      const newEchoRef = push(ref(db, 'echoes'));
      set(newEchoRef, {
        title,
        content,
        author,
        createdAt: now,
        expiresAt: expiration,
        replies: []
      });

      echoTitleInput.value = '';
      echoAuthorInput.value = '';
      echoContentInput.value = '';
      contentModal.classList.remove('show');
    }

    function renderEcho(key, echo) {
      const wrapper = document.createElement('div');
      wrapper.className = 'echo';
      wrapper.setAttribute('data-key', key);

      const foldedContent = document.createElement('div');
      foldedContent.innerHTML = `<strong>${echo.title}</strong> <span class="author">${echo.author}</span> <span class="timer" id="timer-${key}"></span>`;
      wrapper.appendChild(foldedContent);

      const contentDiv = document.createElement('div');
      contentDiv.className = 'echo-content';
      contentDiv.innerHTML = `<p>${echo.content}</p>`;

      const replyBox = document.createElement('div');
      replyBox.innerHTML = `<button class="btn" onclick="openReplyModal('${key}')">Reply</button>`;
      contentDiv.appendChild(replyBox);

      if (echo.replies) {
        Object.entries(echo.replies).forEach(([k, reply]) => {
          const r = document.createElement('div');
          r.className = 'reply';
          r.innerHTML = `<strong>${reply.author}</strong>: ${reply.text}`;
          contentDiv.appendChild(r);
        });
      }

      wrapper.appendChild(contentDiv);
      wrapper.addEventListener('click', () => {
        contentDiv.style.display = contentDiv.style.display === 'none' ? 'block' : 'none';
      });

      echoContainer.appendChild(wrapper);
      updateTimer(key, echo.expiresAt);
    }

    function updateTimer(key, expiresAt) {
      const timer = document.getElementById(`timer-${key}`);
      function update() {
        const remaining = Math.max(0, expiresAt - Date.now());
        const mins = Math.floor(remaining / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        timer.textContent = `(${mins}:${secs.toString().padStart(2, '0')})`;
        if (remaining <= 0) {
          document.querySelector(`[data-key="${key}"]`)?.remove();
        }
      }
      update();
      setInterval(update, 1000);
    }

    window.openReplyModal = (key) => {
      currentEchoKey = key;
      replyModal.classList.add('show');
    };

    window.submitReply = () => {
      const text = replyContentInput.value.trim();
      const author = replyAuthorInput.value.trim() || "Anonymous";
      if (!text) return;

      const reply = { text, author };
      const echoRef = ref(db, `echoes/${currentEchoKey}/replies`);
      push(echoRef, reply);

      const newExpiration = Date.now() + 5 * 60 * 1000;
      update(ref(db, `echoes/${currentEchoKey}`), { expiresAt: newExpiration });

      replyContentInput.value = '';
      replyAuthorInput.value = '';
      replyModal.classList.remove('show');
    };

    onValue(ref(db, 'echoes'), snapshot => {
      echoContainer.innerHTML = '';
      const echoes = snapshot.val();
      if (!echoes) return;

      Object.entries(echoes).forEach(([key, echo]) => {
        renderEcho(key, echo);
      });
    });

    // Open echo modal by default for testing
    openEchoModal();
  </script>
</body>
</html>
