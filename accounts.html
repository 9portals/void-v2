<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Accounts - VOID</title>
  <style>
    body {
      margin: 0;
      background-color: black;
      color: white;
      font-family: monospace;
      text-align: center;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
    }
    #navToggle {
      cursor: pointer;
      font-size: 32px;
      margin-right: 20px;
    }
    nav {
      display: none;
      flex-direction: column;
      position: absolute;
      top: 80px;
      left: 20px;
      background: #111;
      border: 1px solid #444;
      padding: 10px;
    }
    nav a {
      color: white;
      text-decoration: none;
      margin: 5px 0;
    }
    input, select, button {
      margin: 8px;
      padding: 10px;
      background: #111;
      color: white;
      border: 1px solid #444;
    }
    #profilePicPreview {
      max-width: 100px;
      border-radius: 10px;
    }
  </style>
</head>
<body>

<header>
  <div id="navToggle">âˆž</div>
  <h1>ACCOUNTS</h1>
  <nav id="mainNav">
    <a href="index.html">Home</a>
    <a href="echoes.html">Echoes</a>
    <a href="accounts.html">Accounts</a>
  </nav>
</header>

<div id="content">
  <h2>Loading...</h2>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDnLMO0VZ3ItFMF_7u3hOaErF_h1PQoQbs",
    authDomain: "void-d9ec4.firebaseapp.com",
    databaseURL: "https://void-d9ec4-default-rtdb.firebaseio.com",
    projectId: "void-d9ec4",
    storageBucket: "void-d9ec4.appspot.com",
    messagingSenderId: "267268035851",
    appId: "1:267268035851:web:d535fe4175c06f170f3e0e"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  // Header nav toggle
  document.getElementById("navToggle").onclick = () => {
    const nav = document.getElementById("mainNav");
    nav.style.display = nav.style.display === "flex" ? "none" : "flex";
  };

  // Auth state
  auth.onAuthStateChanged(user => {
    if (user) {
      loadProfile(user);
    } else {
      showLoginRegister();
    }
  });

  function showLoginRegister() {
    document.getElementById("content").innerHTML = `
      <h2>Register</h2>
      <input type="email" id="regEmail" placeholder="Email"><br>
      <input type="password" id="regPass" placeholder="Password (min 6)"><br>
      <button onclick="register()">Register</button>

      <h2>Login</h2>
      <input type="email" id="logEmail" placeholder="Email"><br>
      <input type="password" id="logPass" placeholder="Password"><br>
      <button onclick="login()">Login</button>
    `;
  }

  function register() {
    const email = document.getElementById("regEmail").value;
    const pass = document.getElementById("regPass").value;
    if (pass.length < 6) return alert("Password must be at least 6 characters.");
    auth.createUserWithEmailAndPassword(email, pass)
      .then(cred => {
        db.ref("users/" + cred.user.uid).set({ email });
      }).catch(err => alert(err.message));
  }

  function login() {
    const email = document.getElementById("logEmail").value;
    const pass = document.getElementById("logPass").value;
    auth.signInWithEmailAndPassword(email, pass)
      .catch(err => alert(err.message));
  }

  function logout() {
    auth.signOut();
  }

  function loadProfile(user) {
    db.ref("users/" + user.uid).once("value").then(snapshot => {
      const data = snapshot.val() || {};
      renderProfile(user, data);

      // Show other users
      db.ref("users").once("value").then(usersSnap => {
        const users = usersSnap.val();
        let list = "<h3>Other Users</h3>";
        for (const uid in users) {
          if (uid !== user.uid) {
            list += `<p><a href="#" onclick="viewUserProfile('${uid}')">${users[uid].email}</a></p>`;
          }
        }
        document.getElementById("content").innerHTML += list;
      });
    });
  }

  function renderProfile(user, data) {
    document.getElementById("content").innerHTML = `
      <h2>Your Profile</h2>
      <img id="profilePicPreview" src="${data.profilePic || 'https://via.placeholder.com/100'}"><br>
      <input type="file" id="picInput"><br>
      <input type="text" id="bio" placeholder="Bio" value="${data.bio || ''}"><br>
      <input type="number" id="age" placeholder="Age" value="${data.age || ''}"><br>
      <select id="gender">
        <option value="">Select Gender</option>
        <option value="Male" ${data.gender === "Male" ? "selected" : ""}>Male</option>
        <option value="Female" ${data.gender === "Female" ? "selected" : ""}>Female</option>
        <option value="Other" ${data.gender === "Other" ? "selected" : ""}>Other</option>
      </select><br>
      <button onclick="saveProfile()">Save Profile</button>
      <button onclick="logout()">Logout</button>
    `;

    document.getElementById("picInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      const ref = storage.ref("profilePics/" + user.uid);
      ref.put(file).then(() => {
        ref.getDownloadURL().then(url => {
          db.ref("users/" + user.uid).update({ profilePic: url });
          document.getElementById("profilePicPreview").src = url;
        });
      });
    });
  }

  function saveProfile() {
    const bio = document.getElementById("bio").value;
    const age = document.getElementById("age").value;
    const gender = document.getElementById("gender").value;
    const uid = auth.currentUser.uid;
    db.ref("users/" + uid).update({ bio, age, gender }).then(() => {
      alert("Profile updated.");
    });
  }

  function viewUserProfile(uid) {
    db.ref("users/" + uid).once("value").then(snapshot => {
      const data = snapshot.val();
      if (!data) {
        document.getElementById("content").innerHTML = "<p>User not found.</p>";
        return;
      }

      const currentUid = auth.currentUser ? auth.currentUser.uid : null;
      const isOwn = currentUid === uid;

      document.getElementById("content").innerHTML = `
        <h2>${isOwn ? "Your Profile" : "User Profile"}</h2>
        <img src="${data.profilePic || 'https://via.placeholder.com/100'}"><br>
        <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
        <p><strong>Bio:</strong> ${data.bio || ''}</p>
        <p><strong>Age:</strong> ${data.age || ''}</p>
        <p><strong>Gender:</strong> ${data.gender || ''}</p>
        ${!isOwn ? `
          <button onclick="followUser('${uid}')">Follow</button>
          <button onclick="dmUser('${uid}')">Message</button>
        ` : `
          <button onclick="logout()">Logout</button>
          <button onclick="auth.onAuthStateChanged(u => renderProfile(u, data))">Edit Profile</button>
        `}
      `;
    });
  }

  function followUser(targetUid) {
    const currentUid = auth.currentUser.uid;
    db.ref(`follows/${currentUid}/${targetUid}`).set(true).then(() => {
      alert("Followed!");
    });
  }

  function dmUser(targetUid) {
    alert("DM system coming soon...");
  }
</script>

</body>
</html>
