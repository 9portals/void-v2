<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Echoes - The Void</title>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    header {
      padding: 20px;
      text-align: center;
      border-bottom: 1px solid white;
    }
    nav {
      text-align: center;
      margin: 10px 0;
    }
    nav a {
      color: white;
      margin: 0 10px;
      text-decoration: none;
    }
    #echoList {
      padding: 20px;
    }
    .echo {
      border: 1px solid white;
      padding: 10px;
      margin-bottom: 10px;
    }
    .echo h3 {
      margin: 0 0 5px 0;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.8);
    }
    .modal-content {
      background-color: #222;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 400px;
      color: white;
    }
    textarea, input {
      width: 100%;
      margin-bottom: 10px;
      background-color: black;
      color: white;
      border: 1px solid white;
      padding: 5px;
    }
    button {
      background-color: black;
      color: white;
      border: 1px solid white;
      padding: 5px 10px;
      margin: 5px 2px;
      cursor: pointer;
    }
    img, video, audio {
      max-width: 100%;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <header>
    <h1>The Void - Echoes</h1>
  </header>
  <nav>
    <a href="index.html">Home</a>
    <a href="view-profiles.html">View Profiles</a>
    <a href="global-chat.html">Global Chat</a>
    <a href="echoes.html">Echoes</a>
    <a href="edit-profile.html">Edit Profile</a>
    <a href="login.html">Login</a>
    <a href="signup.html">Signup</a>
  </nav>
  <div style="text-align:center;">
    <button onclick="startEcho()">Create Echo</button>
  </div>
  <div id="echoList"></div>

  <!-- Echo Modal -->
  <div class="modal" id="echoModal">
    <div class="modal-content">
      <div id="modalTitle"></div>
      <input id="echoUsername" placeholder="Enter username (or leave blank for Anonymous)" />
      <textarea id="echoBody" placeholder="Write your echo..."></textarea>
      <input type="file" id="mediaUpload" accept="image/*,video/*,audio/*" style="display:none" />
      <button id="mediaUploadBtn">Attach Media</button>
      <button id="submitEcho">Post Echo</button>
      <button onclick="echoModal.style.display='none'">Cancel</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      onChildAdded,
      remove
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import {
      getStorage,
      ref as storageRef,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBPzkvlhxV0ymOZ67BlEVBgTkmkdE8R0kA",
      authDomain: "void-d9ec4.firebaseapp.com",
      databaseURL: "https://void-d9ec4-default-rtdb.firebaseio.com",
      projectId: "void-d9ec4",
      storageBucket: "void-d9ec4.appspot.com",
      messagingSenderId: "267268035851",
      appId: "1:267268035851:web:d535fe4175c06f170f3e0e"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const storage = getStorage(app);
    const echoesRef = ref(database, "echoes");

    const echoModal = document.getElementById("echoModal");
    const modalTitle = document.getElementById("modalTitle");
    const echoBody = document.getElementById("echoBody");
    const echoUsername = document.getElementById("echoUsername");
    const mediaUploadInput = document.getElementById("mediaUpload");
    let selectedFile = null;

    document.getElementById("mediaUploadBtn").onclick = () => {
      mediaUploadInput.click();
    };

    mediaUploadInput.onchange = (e) => {
      selectedFile = e.target.files[0];
    };

    function startEcho() {
      echoUsername.value = "";
      echoBody.value = "";
      selectedFile = null;
      modalTitle.innerHTML = `<h3>New Echo</h3>`;
      echoModal.style.display = "block";
    }

    document.getElementById("submitEcho").onclick = async () => {
      const username = echoUsername.value.trim() || "Anonymous";
      const body = echoBody.value.trim();
      if (!body) return;

      let mediaURL = "";
      let mediaType = "";

      if (selectedFile) {
        const filePath = `media/${Date.now()}_${selectedFile.name}`;
        const fileRef = storageRef(storage, filePath);
        await uploadBytes(fileRef, selectedFile);
        mediaURL = await getDownloadURL(fileRef);
        mediaType = selectedFile.type.split("/")[0]; // image, video, audio
      }

      const now = Date.now();
      const echoData = {
        username,
        body,
        timestamp: now,
        expiresAt: now + 10 * 60 * 1000, // 10 minutes
        mediaURL,
        mediaType
      };

      await push(echoesRef, echoData);
      echoModal.style.display = "none";
    };

    onChildAdded(echoesRef, (data) => {
      const echo = data.val();
      const key = data.key;
      const now = Date.now();
      if (echo.expiresAt <= now) {
        remove(ref(database, `echoes/${key}`));
        return;
      }

      const div = document.createElement("div");
      div.className = "echo";

      const countdownSpan = document.createElement("span");
      countdownSpan.style.fontSize = "12px";
      updateCountdown();

      function updateCountdown() {
        const remaining = Math.max(0, echo.expiresAt - Date.now());
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        countdownSpan.textContent = `Time left: ${minutes}m ${seconds}s`;
        if (remaining <= 0) {
          div.remove();
          remove(ref(database, `echoes/${key}`));
        }
      }

      setInterval(updateCountdown, 1000);

      div.innerHTML = `
        <h3>${echo.username}</h3>
        <p>${echo.body}</p>
      `;
      div.appendChild(countdownSpan);

      if (echo.mediaURL && echo.mediaType) {
        if (echo.mediaType === "image") {
          const img = document.createElement("img");
          img.src = echo.mediaURL;
          div.appendChild(img);
        } else if (echo.mediaType === "video") {
          const video = document.createElement("video");
          video.src = echo.mediaURL;
          video.controls = true;
          div.appendChild(video);
        } else if (echo.mediaType === "audio") {
          const audio = document.createElement("audio");
          audio.src = echo.mediaURL;
          audio.controls = true;
          div.appendChild(audio);
        }
      }

      document.getElementById("echoList").prepend(div);
    });
  </script>
</body>
</html>
