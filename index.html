<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VOID Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      background-color: black;
      color: white;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    #chat-container {
      margin-top: 30vh;
      width: 90%;
      max-width: 600px;
    }
    #messages {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column-reverse;
      gap: 10px;
    }
    .message {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 5px;
      position: relative;
    }
    .countdown {
      font-size: 0.8em;
      color: #888;
      position: absolute;
      bottom: 5px;
      right: 10px;
    }
    #input-area {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    input[type="text"] {
      background: black;
      color: white;
      border: 2px solid #555;
      padding: 10px;
      width: 70%;
      font-size: 1em;
      border-radius: 3px;
    }
    button {
      background: #111;
      color: white;
      border: 2px solid #444;
      padding: 10px 15px;
      cursor: pointer;
      font-size: 1em;
      border-radius: 3px;
    }
    button:hover {
      background: #222;
    }
    a {
      color: #3399ff;
      text-decoration: none;
    }
  </style>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      orderBy,
      onSnapshot,
      serverTimestamp,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD1YgjFsxh-xZfeHlrxt_0igmH6SBIMcuc",
      authDomain: "void-d9ec4.firebaseapp.com",
      projectId: "void-d9ec4",
      storageBucket: "void-d9ec4.firebasestorage.app",
      messagingSenderId: "267268035851",
      appId: "1:267268035851:web:1e5ab79c51db42160f3e0e",
      measurementId: "G-ZYMQ3Z6LC5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const messagesRef = collection(db, "messages");

    const input = document.getElementById("messageInput");
    const messagesDiv = document.getElementById("messages");

    document.getElementById("sendButton").addEventListener("click", async () => {
      const text = input.value.trim();
      if (text !== "") {
        await addDoc(messagesRef, {
          text: text,
          timestamp: serverTimestamp(),
          isAuto: false
        });
        input.value = "";
      }
    });

    const timers = new Map();

    function startCountdown(docId, messageEl, timeLeft) {
      const countdownEl = messageEl.querySelector(".countdown");
      const timer = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) {
          clearInterval(timer);
          messageEl.remove();
          deleteDoc(doc(db, "messages", docId));
        } else {
          countdownEl.textContent = `${timeLeft}s`;
        }
      }, 1000);
      timers.set(docId, timer);
    }

    const q = query(messagesRef, orderBy("timestamp", "desc"));
    onSnapshot(q, snapshot => {
      const docs = snapshot.docs.filter(d => d.data().timestamp);
      // If there are more than 10 messages, remove the one closest to expiring
      if (docs.length > 10) {
        let soonestId = null;
        let soonestTime = Infinity;
        docs.forEach(d => {
          const timeLeft = 60 - Math.floor((Date.now() - d.data().timestamp.toDate()) / 1000);
          if (timeLeft < soonestTime) {
            soonestTime = timeLeft;
            soonestId = d.id;
          }
        });
        if (soonestId) {
          deleteDoc(doc(db, "messages", soonestId));
        }
      }

      messagesDiv.innerHTML = "";

      docs.forEach(docSnap => {
        const data = docSnap.data();
        const timeDiff = 60 - Math.floor((Date.now() - data.timestamp.toDate()) / 1000);
        if (timeDiff <= 0) {
          deleteDoc(doc(db, "messages", docSnap.id));
          return;
        }

        const messageEl = document.createElement("div");
        messageEl.classList.add("message");
        messageEl.innerHTML = `<span>${data.text}</span><span class="countdown">${timeDiff}s</span>`;
        messagesDiv.appendChild(messageEl);
        startCountdown(docSnap.id, messageEl, timeDiff);
      });
    });

    // Auto message every 2 minutes
    setInterval(async () => {
      const phrases = [
        'A whisper echoes. <a href="#">(void whisper)</a>',
        'The silence speaks. <a href="#">(click)</a>',
        'From nothing, a thought... <a href="#">(see)</a>',
        'You are not alone in the void. <a href="#">(visit)</a>'
      ];
      const random = phrases[Math.floor(Math.random() * phrases.length)];
      await addDoc(messagesRef, {
        text: random,
        timestamp: serverTimestamp(),
        isAuto: true
      });
    }, 120000);
  </script>
</head>
<body>
  <div id="chat-container">
    <div id="messages"></div>
    <div id="input-area">
      <input id="messageInput" type="text" placeholder="Say something into the void..." />
      <button id="sendButton">Send</button>
    </div>
  </div>
</body>
</html>
